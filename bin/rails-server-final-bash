#!/usr/bin/env bash
# A final bash script to start the Rails server with all necessary services

# Function to log messages with timestamps
log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Check if PostgreSQL is running
log "Checking PostgreSQL status..."
if pg_isready -q; then
  log "PostgreSQL is already running."
else
  log "ERROR: PostgreSQL is not running. Please start it manually."
  exit 1
fi

# Check if Redis is running
log "Checking Redis status..."
if redis-cli ping > /dev/null 2>&1; then
  log "Redis is already running."
else
  log "ERROR: Redis is not running. Please start it manually."
  exit 1
fi

# Kill any existing SolidQueue processes
log "Checking for existing SolidQueue processes..."
pkill_output=$(pgrep -f "solid_queue_monitor.rb" || echo "")
if [ -n "$pkill_output" ]; then
  log "Killing existing SolidQueue processes: $pkill_output"
  pkill -f solid_queue_monitor.rb
  sleep 2

  # Double-check that processes are actually killed
  pkill_output=$(pgrep -f "solid_queue_monitor.rb" || echo "")
  if [ -n "$pkill_output" ]; then
    log "Forcefully killing remaining processes: $pkill_output"
    pkill -9 -f solid_queue_monitor.rb
    sleep 1
  fi
fi

# Kill any existing Rails runner processes
log "Checking for existing Rails runner processes..."
pkill_output=$(pgrep -f "rails runner" || echo "")
if [ -n "$pkill_output" ]; then
  log "Killing existing Rails runner processes: $pkill_output"
  pkill -f "rails runner"
  sleep 2

  # Double-check that processes are actually killed
  pkill_output=$(pgrep -f "rails runner" || echo "")
  if [ -n "$pkill_output" ]; then
    log "Forcefully killing remaining processes: $pkill_output"
    pkill -9 -f "rails runner"
    sleep 1
  fi
fi

# Clean up any stale PID files
log "Cleaning up stale PID files..."
find tmp/pids -name "*.pid" -delete 2>/dev/null || true
find tmp/pids -name "*.lock" -delete 2>/dev/null || true

# Set environment variable to use inline adapter for ActiveJob
export ACTIVE_JOB_ADAPTER=inline
export SKIP_SOLID_QUEUE=true

# Start the Rails server directly
log "Starting Rails server..."
exec bundle exec rails server "$@"
